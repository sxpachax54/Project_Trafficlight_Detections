<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Traffic Light Detector AI</title>
    <link rel="manifest" href="/static/manifest.json?v=2">
    <link rel="apple-touch-icon" href="/static/logo.png?v=2">
    <link rel="icon" type="image/png" href="/static/logo.png?v=2">

    <meta name="theme-color" content="#1a1a2e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
       
        * { box-sizing: border-box; }

        :root {
            
            --bg-color: #1a1a2e;
            --panel-color: #16213e;
            --accent-color: #0f3460;
            --text-color: #c4b5fd;
            --text-main: #ffffff;
            --sidebar-width: 300px;

            
            --btn-grad-start: #c4b5fd;
            --btn-grad-end: #8b5cf6;

           
            --toggle-bg: #2e3b55;
            --toggle-knob: #F4F6F0;
            --toggle-border: #4b5563;
            --toggle-icon: #2b3270;
        }

       
        body.day-mode {
            --bg-color: #F0F8FF;
            --panel-color: #FFFFFF;
            --accent-color: #E3F2FD;
            --text-color: #007bff; 
            --text-main: #2C3E50;

            --btn-grad-start: #87CEEB;
            --btn-grad-end: #4fc3f7;

            /* Toggle Switch Colors (Day) */
            --toggle-bg: #87CEEB;
            --toggle-knob: #FFD700;
            --toggle-border: #B0E0E6;
            --toggle-icon: #d35400;
        }

        body {
            font-family: 'Prompt', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
            transition: background-color 0.5s ease, color 0.5s ease;
        }

        /* --- Liquid Glass Button Style --- */
        .control-panel button,
        .liquid-btn {
            position: relative;
            border: none;
            background: linear-gradient(145deg, var(--btn-grad-start), var(--btn-grad-end));
            color: white !important;
            padding: 12px 20px;
            border-radius: 50px;
            cursor: pointer;
            font-family: 'Prompt', sans-serif;
            font-weight: 600;
            font-size: 14px;
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);

            box-shadow:
                0 4px 6px rgba(0, 0, 0, 0.2),
                inset 0 2px 2px rgba(255, 255, 255, 0.4),
                inset 0 -2px 2px rgba(0, 0, 0, 0.1);

            border-top: 1px solid rgba(255, 255, 255, 0.4);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .control-panel button::after,
        .liquid-btn::after {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 100%; height: 50%;
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0.2), transparent);
            border-radius: 50px 50px 0 0;
            pointer-events: none;
        }

        .control-panel button:hover,
        .liquid-btn:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 7px 14px rgba(0, 0, 0, 0.25), inset 0 2px 2px rgba(255, 255, 255, 0.6);
            filter: brightness(1.1);
        }

        .control-panel button:active,
        .liquid-btn:active {
            transform: translateY(1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .control-panel button.stop {
            background: linear-gradient(145deg, #ff6b6b, #e05252);
        }

        body.day-mode .control-panel button.view-btn {
            background: linear-gradient(145deg, #ffffff, #e6e6e6);
            color: var(--text-color) !important;
            border: 1px solid var(--text-color);
        }

        /* --- ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏∏‡πà‡∏°‡∏¢‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π (Sidebar Toggle) --- */
        #toggleSidebarBtn {
            position: absolute;
            top: 20px;
            left: var(--sidebar-width);
            z-index: 200;
            background: var(--panel-color) !important; 
            color: var(--text-color) !important;
            border: 1px solid rgba(255, 255, 255, 0.1);
            width: 45px;
            height: 45px;
            border-radius: 0 15px 15px 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 4px 0 10px rgba(0, 0, 0, 0.1);
            padding: 0;
        }

        #toggleSidebarBtn:hover {
            background: var(--text-color) !important;
            color: #fff !important;
        }

        body.day-mode #toggleSidebarBtn {
            border: 1px solid #ddd;
            box-shadow: 2px 0 5px rgba(0,0,0,0.15);
        }

        .sidebar.collapsed~#toggleSidebarBtn { left: 0; }
        .sidebar.collapsed~#toggleSidebarBtn i { transform: rotate(180deg); }


        /* --- Custom Toggle Switch --- */
        .mode-toggle-wrapper {
            display: flex;
            justify-content: center;
            width: 100%;
            margin-top: 5px;
        }

        .mode-toggle {
            position: relative;
            width: 100%;
            height: 60px;
            border-radius: 30px;
            cursor: pointer;
            overflow: hidden;
            transition: all 0.4s ease;
            background: var(--toggle-bg);
            border: 3px solid rgba(255, 255, 255, 0.2);
            box-shadow: inset 0 4px 10px rgba(0, 0, 0, 0.15), 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .toggle-checkbox { display: none; }

        .toggle-scenery {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; overflow: hidden; border-radius: 30px;
        }

        /* ‚òÅÔ∏è Cloud Shape */
        .cloud-group { position: absolute; transition: all 0.6s ease; }
        .cloud-circle {
            position: absolute; background: #fff; border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            transition: background 0.5s ease, opacity 0.5s ease;
        }

        /* ‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏°‡∏Ü‡∏ã‡πâ‡∏≤‡∏¢ */
        .cloud-group-1 { bottom: -10px; left: 10px; }
        .cloud-group-1 .c1 { width: 25px; height: 25px; bottom: 5px; left: 70px; }
        .cloud-group-1 .c2 { width: 25px; height: 25px; bottom: 25px; left: 4px; }
        .cloud-group-1 .c3 { width: 35px; height: 35px; bottom: 5px; left: -15px; }
        .cloud-group-1 .c4 { width: 55px; height: 55px; bottom: 0; left: 10px; }
        .cloud-group-1 .c5 { width: 40px; height: 40px; bottom: 0px; left: 45px; }
        .cloud-group-1 .c6 { width: 35px; height: 35px; bottom: -15px; left: 72px; }

        /* ‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏°‡∏Ü‡∏Ç‡∏ß‡∏≤ */
        .cloud-group-2 { bottom: 15px; left: 65%; transform: scale(0.6); } 
        .cloud-group-2 .c1 { width: 60px; height: 60px; }
        .cloud-group-2 .c2 { width: 40px; height: 40px; left: 25px; bottom: -20px; z-index: -1; }
        .cloud-group-2 .c3 { width: 80px; height: 80px; left: 40px; bottom: -50px; z-index: -1; }
        .cloud-group-2 .c4 { width: 40px; height: 40px; left: 100px; }
        .cloud-group-2 .c5 { width: 20px; height: 20px; left: 135px; bottom: -35px; }

        /* ‚ú® Stars */
        .star {
            position: absolute; background: #fff; border-radius: 50%;
            transition: opacity 0.5s ease;
            box-shadow: 0 0 6px rgba(255, 255, 255, 0.9);
            animation: twinkle 3s infinite ease-in-out;
        }
        .star:nth-child(1) { width: 3px; height: 3px; top: 15%; left: 20%; animation-delay: 0s; }
        .star:nth-child(2) { width: 2px; height: 2px; top: 30%; left: 45%; animation-delay: 1s; }
        .star:nth-child(3) { width: 2px; height: 2px; top: 15%; right: 35%; animation-delay: 2s; }
        .star:nth-child(4) { width: 4px; height: 4px; top: 40%; right: 15%; animation-delay: 0.5s; }
        .star:nth-child(5) { width: 1px; height: 1px; top: 60%; left: 23%; animation-delay: 1.5s; }
        .star:nth-child(6) { width: 2px; height: 2px; top: 70%; left: 35%; animation-delay: 2.5s; }
        .star:nth-child(7) { width: 2px; height: 2px; top: 40%; right: 50%; animation-delay: 0.8s; }
        .star:nth-child(8) { width: 3px; height: 3px; top: 80%; right: 35%; animation-delay: 0.3s; }
        .star:nth-child(9) { width: 2px; height: 2px; top: 25%; left: 18%; animation-delay: 1.2s; }
        .star:nth-child(10) { width: 1.5px; height: 1.5px; top: 15%; left: 30%; animation-delay: 2.2s; }
        .star:nth-child(11) { width: 3px; height: 3px; top: 80%; left: 90%; animation-delay: 1.2s; }
        .star:nth-child(12) { width: 1.5px; height: 1.5px; top: 20%; left: 95%; animation-delay: 1.5s; }

        /* Shooting Stars */
        .shooting-star {
            position: absolute; width: 40px; height: 1px;
            background: linear-gradient(to right, rgba(255,255,255,0), #fff);
            transform: rotate(-20deg) translateX(-50px); opacity: 0;
        }
        .shooting-star.s1 { top: 20px; left: 10px; animation: shoot 5s infinite 0s; }
        .shooting-star.s2 { top: 35px; left: 0px; width: 30px; animation: shoot 6s infinite 2s; }
        .shooting-star.s3 { top: 10px; left: 20px; width: 50px; animation: shoot 7s infinite 4s; }

        @keyframes twinkle { 0%, 100% { opacity: 0.4; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.2); } }
        @keyframes shoot { 0% { transform: rotate(-20deg) translateX(-50px); opacity: 0; } 10% { opacity: 1; } 20% { transform: rotate(-20deg) translateX(300px); opacity: 0; } 100% { transform: rotate(-20deg) translateX(300px); opacity: 0; } }

        /* Logic Scenery */
        body.day-mode .cloud-circle { background: rgba(255, 255, 255, 0.95); box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); }
        body.day-mode .star, body.day-mode .shooting-star { opacity: 0; animation: none; }
        .toggle-checkbox:checked+.mode-toggle .cloud-circle { background: #57606f; box-shadow: none; }
        .toggle-checkbox:checked+.mode-toggle .star, .toggle-checkbox:checked+.mode-toggle .shooting-star { opacity: 1; }

        /* Knob */
        .toggle-knob {
            position: absolute; top: 6px; right: 6px; width: 48px; height: 48px;
            background: var(--toggle-knob); border-radius: 50%;
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3), inset 0 -3px 3px rgba(0, 0, 0, 0.1), inset 0 2px 5px rgba(255, 255, 255, 1);
            z-index: 5;
        }
        .toggle-knob i { font-size: 26px; color: var(--toggle-icon); filter: drop-shadow(0 1px 1px rgba(0, 0, 0, 0.2)); transition: color 0.3s; }
        .toggle-text {
            position: absolute; top: 50%; transform: translateY(-50%);
            font-size: 16px; font-weight: 700; color: #fff; z-index: 2;
            transition: all 0.3s ease; text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            left: 20px; right: auto; color: #2c3e50;
        }
        .toggle-checkbox:checked+.mode-toggle .toggle-knob { right: calc(100% - 54px); transform: rotate(-360deg); }
        .toggle-checkbox:checked+.mode-toggle .toggle-text { left: auto; right: 20px; color: #fff; }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width); min-width: var(--sidebar-width);
            background-color: var(--panel-color); padding: 20px;
            box-shadow: 2px 0 15px rgba(0, 0, 0, 0.15);
            display: flex; flex-direction: column; gap: 20px;
            z-index: 100; overflow-y: auto;
            transition: transform 0.3s ease, background-color 0.5s ease;
            position: absolute; height: 100%; left: 0; top: 0;
        }
        .sidebar.collapsed { transform: translateX(-100%); }

        .main-content { flex-grow: 1; position: relative; background-color: #000; width: 100%; height: 100%; overflow: hidden; }

        #landing-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: linear-gradient(135deg, var(--bg-color) 0%, var(--panel-color) 100%);
            z-index: 50; text-align: center; transition: background 0.5s ease;
        }
        #landing-overlay i { font-size: 80px; color: var(--text-color); margin-bottom: 20px; transition: color 0.5s ease; filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.1)); }
        #landing-overlay h2 { font-size: 28px; margin: 0; color: var(--text-main); transition: color 0.5s ease; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
        #landing-overlay p { color: var(--text-main); opacity: 0.7; margin-top: 10px; transition: color 0.5s ease; }
        .active-mode #landing-overlay { display: none; }

        #container { position: relative; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; overflow: hidden; background-color: #000; }
        video, img { display: block; max-width: 100%; max-height: 100%; width: auto; height: auto; }
        canvas { position: absolute; pointer-events: none; z-index: 10; }

        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; }
        button.sound-on { background: linear-gradient(145deg, #2ecc71, #27ae60); }
        button.sound-off { background: linear-gradient(145deg, #95a5a6, #7f8c8d); }

        #mobile-hud {
            display: none; position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; z-index: 150;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border-radius: 20px; padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white; 
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }

        /* ‚úÖ 2. ‡πÅ‡∏Å‡πâ‡∏™‡∏µ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç HUD ‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô */
        body.day-mode #mobile-hud {
            color: #333;
            text-shadow: 0 1px 0 rgba(255,255,255,0.8);
        }

        .hud-stats { display: flex; justify-content: space-around; margin-bottom: 10px; font-size: 14px; }
        .hud-stat-item { display: flex; flex-direction: column; align-items: center; }
        .hud-stat-item span:first-child { font-size: 18px; margin-bottom: 2px; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5); }
        .hud-stat-item span:last-child { font-size: 12px; opacity: 0.9; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5); }
        
        .desktop-only { display: block; }
        select { width: 100%; padding: 12px; border-radius: 15px; margin-top: 5px; border: 1px solid rgba(0, 0, 0, 0.1); background: var(--bg-color); color: var(--text-main); transition: 0.3s; box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05); font-family: 'Prompt', sans-serif; }

        @keyframes flashRed { 0%, 100% { box-shadow: inset 0 0 0 0 transparent; } 50% { box-shadow: inset 0 0 50px 20px rgba(255, 0, 0, 0.8); } }
        .alert-Red { animation: flashRed 1s infinite; border: 2px solid red; }
        .alert-Green { border: 2px solid #00ff00; }
        .alert-Yellow { border: 2px solid yellow; }

        @media (max-width: 768px) {
            :root { --sidebar-width: 100%; }
            .sidebar { position: fixed; }
            .sidebar.collapsed { transform: translateX(-100%); }
            #toggleSidebarBtn { left: auto; right: 20px; border-radius: 10px; height: 40px; width: 40px; }
            .sidebar.collapsed~#toggleSidebarBtn { left: auto; right: 20px; }
            #mobile-hud { display: block; }
            .desktop-only { display: none; }
        }
    </style>
</head>

<body class="day-mode">

    <div id="mySidebar" class="sidebar">
        <div style="text-align: center; margin-bottom: 20px;">
            <h1 style="color: var(--text-color); font-size: 24px; text-shadow: 0 2px 4px rgba(0,0,0,0.1);">üö¶ Traffic AI</h1>
            <p style="font-size: 12px; color: var(--text-main); opacity: 0.7;">YOLOv11 Detection</p>
        </div>

        <div class="control-panel">
            <div style="margin-bottom: 15px;">
                <label style="color: var(--text-main); font-weight: 600;"><i class="fas fa-camera"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á:</label>
                <select id="cameraSelect" onchange="startCamera()">
                    <option value="environment">‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á (Auto)</option>
                    <option value="user">‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤</option>
                </select>
            </div>

            <div class="btn-group">
                <button onclick="startCamera()"><i class="fas fa-video"></i> ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
                <button class="stop" onclick="stopCamera()"><i class="fas fa-stop"></i> ‡∏´‡∏¢‡∏∏‡∏î</button>
            </div>

            <div class="btn-group" style="margin-top: 10px;">
                <button class="view-btn" onclick="manualClear()"><i class="fas fa-eraser"></i> ‡∏•‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠</button>
            </div>

            <div class="btn-group" style="margin-top: 10px;">
                <button id="soundBtn" class="sound-off" onclick="toggleSound()">
                    <i class="fas fa-volume-mute"></i> ‡πÄ‡∏™‡∏µ‡∏¢‡∏á: ‡∏õ‡∏¥‡∏î
                </button>
            </div>

            <div class="btn-group" style="margin-top: 10px;">
                <button class="view-btn" onclick="toggleFullscreen()">
                    <i class="fas fa-expand"></i> ‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠
                </button>
            </div>

            <div style="margin-top: 15px;">
                <label for="uploadInput" class="liquid-btn">
                    <i class="fas fa-upload"></i> ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
                </label>
                <input type="file" id="uploadInput" accept="image/*" onchange="uploadImage()" style="display: none;">
            </div>
        </div>

        <div class="desktop-only" style="margin-top: 20px;">
            <h2 style="font-size: 16px; border-bottom: 1px solid var(--text-main); padding-bottom: 5px; color: var(--text-main);">Mode</h2>
            
            <div class="mode-toggle-wrapper">
                <input type="checkbox" id="modeSwitchDesktop" class="toggle-checkbox" onchange="toggleDayNight(this.checked)">
                <label for="modeSwitchDesktop" class="mode-toggle">
                    <div class="toggle-scenery">
                        <div class="cloud-group cloud-group-1"><span class="cloud-circle c1"></span><span class="cloud-circle c2"></span><span class="cloud-circle c3"></span><span class="cloud-circle c4"></span><span class="cloud-circle c5"></span><span class="cloud-circle c6"></span></div>
                        <div class="cloud-group cloud-group-2"><span class="cloud-circle c1"></span><span class="cloud-circle c2"></span><span class="cloud-circle c3"></span><span class="cloud-circle c4"></span><span class="cloud-circle c5"></span></div>
                        <span class="star"></span><span class="star"></span><span class="star"></span><span class="star"></span><span class="star"></span><span class="star"></span><span class="star"></span><span class="star"></span><span class="star"></span><span class="star"></span><span class="star"></span><span class="star"></span>
                        <span class="shooting-star s1"></span><span class="shooting-star s2"></span><span class="shooting-star s3"></span>
                    </div>
                    <span class="toggle-text desk-text">DAY MODE (70%)</span>
                    <span class="toggle-knob"><i class="fas fa-sun"></i></span>
                </label>
            </div>
        </div>

        <div class="stats-box desktop-only" style="margin-top: 20px; background: rgba(0,0,0,0.05); padding: 15px; border-radius: 15px;">
            <h2 style="font-size: 16px; margin-bottom: 10px; color: var(--text-main);">Live Stats</h2>
            <div class="stat-item" style="color: var(--text-main);"><span>üî¥ Red:</span><span class="stat-red-val">0</span></div>
            <div class="stat-item" style="color: var(--text-main);"><span>üü° Yellow:</span><span class="stat-yellow-val">0</span></div>
            <div class="stat-item" style="color: var(--text-main);"><span>üü¢ Green:</span><span class="stat-green-val">0</span></div>
        </div>
    </div>

    <button id="toggleSidebarBtn" onclick="toggleSidebar()">
        <i class="fas fa-chevron-left"></i>
    </button>

    <div class="main-content">
        <div id="landing-overlay">
            <i class="fas fa-traffic-light"></i>
            <h2>Traffic Light AI</h2>
            <p>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
        </div>

        <div id="container">
            <div id="visualOverlay" style="position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:99;"></div>
            
            <video id="video" autoplay playsinline style="display: none;"></video>
            <img id="staticImage" style="display: none;">
            <canvas id="canvas"></canvas>

            <div id="mobile-hud">
                <div class="hud-stats">
                    <div class="hud-stat-item"><span>üî¥ <b class="stat-red-val">0</b></span></div>
                    <div class="hud-stat-item"><span>üü° <b class="stat-yellow-val">0</b></span></div>
                    <div class="hud-stat-item"><span>üü¢ <b class="stat-green-val">0</b></span></div>
                </div>
                
                <div class="mode-toggle-wrapper">
                    <input type="checkbox" id="modeSwitchMobile" class="toggle-checkbox" onchange="toggleDayNight(this.checked)">
                    <label for="modeSwitchMobile" class="mode-toggle">
                        <div class="toggle-scenery">
                            <div class="cloud-group cloud-group-1"><span class="cloud-circle c1"></span><span class="cloud-circle c2"></span><span class="cloud-circle c3"></span><span class="cloud-circle c4"></span><span class="cloud-circle c5"></span><span class="cloud-circle c6"></span></div>
                            <div class="cloud-group cloud-group-2"><span class="cloud-circle c1"></span><span class="cloud-circle c2"></span><span class="cloud-circle c3"></span><span class="cloud-circle c4"></span><span class="cloud-circle c5"></span></div>
                            <span class="star"></span><span class="star"></span><span class="star"></span><span class="star"></span><span class="star"></span><span class="star"></span><span class="star"></span><span class="star"></span><span class="star"></span><span class="star"></span><span class="star"></span><span class="star"></span>
                            <span class="shooting-star s1"></span><span class="shooting-star s2"></span><span class="shooting-star s3"></span>
                        </div>
                        <span class="toggle-text mob-text">DAY MODE (70%)</span>
                        <span class="toggle-knob"><i class="fas fa-sun"></i></span>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <script>
        const video = document.getElementById('video');
        const staticImage = document.getElementById('staticImage');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const cameraSelect = document.getElementById('cameraSelect');
        const visualOverlay = document.getElementById('visualOverlay');
        const soundBtn = document.getElementById('soundBtn');
        const sidebar = document.getElementById('mySidebar');
        
        let currentConf = 0.70;
        let isStreaming = false;
        let isImageMode = false;
        let lastSpokenLabel = "";
        let lastSpokenTime = 0;
        let isSoundEnabled = false;

        function toggleDayNight(isNight) {
            currentConf = isNight ? 0.40 : 0.70;
            document.getElementById('modeSwitchDesktop').checked = isNight;
            document.getElementById('modeSwitchMobile').checked = isNight;
            const textElements = document.querySelectorAll('.toggle-text');
            const icons = document.querySelectorAll('.toggle-knob i');
            if (isNight) {
                document.body.classList.remove('day-mode');
                textElements.forEach(el => el.innerText = "NIGHT MODE (40%)");
                icons.forEach(el => { el.className = "fas fa-moon"; el.style.color = "#2b3270"; });
            } else {
                document.body.classList.add('day-mode');
                textElements.forEach(el => el.innerText = "DAY MODE (70%)");
                icons.forEach(el => { el.className = "fas fa-sun"; el.style.color = "#d35400"; });
            }
            if (isImageMode) processStaticImage();
        }

        function toggleSidebar() { sidebar.classList.toggle('collapsed'); }

        function enterActiveMode() {
            document.body.classList.add('active-mode'); 
            if (!sidebar.classList.contains('collapsed')) {
                toggleSidebar(); 
            }
        }

        function internalReset() {
            isStreaming = false;
            isImageMode = false;
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
            video.style.display = 'none';
            staticImage.src = "";
            staticImage.style.display = 'none';
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            visualOverlay.className = '';
            updateStats([]);
        }
        
        function manualClear() {
            internalReset();
            document.body.classList.remove('active-mode');
            if (sidebar.classList.contains('collapsed')) toggleSidebar();
        }

        async function getCameras() {
            try {
                await navigator.mediaDevices.getUserMedia({ video: true });
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                cameraSelect.innerHTML = '';
                videoDevices.forEach((device, index) => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    option.text = device.label || `Camera ${index + 1}`;
                    cameraSelect.appendChild(option);
                });
                if (videoDevices.length === 0) {
                     const option = document.createElement('option');
                     option.text = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á";
                     cameraSelect.appendChild(option);
                }
            } catch (err) { console.error(err); }
        }
        getCameras();

        async function startCamera() {
            internalReset(); 
            enterActiveMode();
            video.style.display = 'block';
            if (isSoundEnabled) {
                const dummyUtterance = new SpeechSynthesisUtterance("‡πÄ‡∏£‡∏¥‡πà‡∏°");
                dummyUtterance.lang = 'th-TH'; dummyUtterance.volume = 0.1;
                window.speechSynthesis.speak(dummyUtterance);
            }
            const selectedValue = cameraSelect.value;
            let constraints = { video: { width: { ideal: 1280 }, height: { ideal: 720 } } };
            if (selectedValue === 'environment' || selectedValue === 'user') {
                constraints.video.facingMode = selectedValue;
            } else {
                constraints.video.deviceId = { exact: selectedValue };
            }
            try {
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                handleStream(stream);
            } catch (err) {
                console.log("Retry with basic constraints...");
                try {
                    const fallbackStream = await navigator.mediaDevices.getUserMedia({ video: true });
                    handleStream(fallbackStream);
                } catch (finalErr) {
                    alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î '‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï'");
                }
            }
        }
        
        function handleStream(stream) {
            video.srcObject = stream;
            video.onloadedmetadata = () => {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                updateCanvasSize();
                isStreaming = true;
                detectFrame();
            };
        }

        function stopCamera() {
            isStreaming = false;
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
            if (!isImageMode) {
                 video.style.display = 'none';
                 ctx.clearRect(0, 0, canvas.width, canvas.height);
                 document.body.classList.remove('active-mode');
                 if (sidebar.classList.contains('collapsed')) toggleSidebar();
            }
        }

        // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡∏ô‡∏≤‡∏î Canvas (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß: ‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏†‡∏≤‡∏û‡∏ñ‡πâ‡∏≤‡∏ß‡∏≤‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô)
        function updateCanvasSize() {
            let source = isImageMode ? staticImage : video;
            if (source.style.display === 'none') return;

            // 1. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á CSS (‡∏ó‡∏≥‡∏ï‡∏•‡∏≠‡∏î‡πÑ‡∏î‡πâ ‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏†‡∏≤‡∏û)
            canvas.style.width = source.offsetWidth + "px";
            canvas.style.height = source.offsetHeight + "px";
            canvas.style.top = source.offsetTop + "px";
            canvas.style.left = source.offsetLeft + "px";

            // 2. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô
            let targetWidth, targetHeight;
            if (isStreaming) {
                targetWidth = source.offsetWidth;
                targetHeight = source.offsetHeight;
            } else if (isImageMode) {
                targetWidth = source.naturalWidth;
                targetHeight = source.naturalHeight;
            }

            // 3. ‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡πà‡∏≠‡∏ô! ‡∏ñ‡πâ‡∏≤‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏ó‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏° "‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ" (‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡∏•‡∏ö‡∏†‡∏≤‡∏û‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏¥‡πâ‡∏á)
            if (canvas.width !== targetWidth || canvas.height !== targetHeight) {
                canvas.width = targetWidth;
                canvas.height = targetHeight;
            }
        }

        async function detectFrame() {
            if (!isStreaming) return;
            
            updateCanvasSize(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡∏ô‡∏≤‡∏î‡∏ó‡∏∏‡∏Å‡πÄ‡∏ü‡∏£‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏∏‡∏ô‡∏à‡∏≠
            
            const tempCanvas = document.createElement('canvas');
            // ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏™‡πà‡∏á‡πÑ‡∏õ‡πÉ‡∏´‡πâ AI Detect (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥)
            tempCanvas.width = video.videoWidth;
            tempCanvas.height = video.videoHeight;
            tempCanvas.getContext('2d').drawImage(video, 0, 0);

            tempCanvas.toBlob(async (blob) => {
                if (!blob) return;
                const formData = new FormData();
                formData.append("file", blob, "frame.jpg");
                formData.append("conf_thres", currentConf);

                try {
                    const response = await fetch('/predict', { method: 'POST', body: formData });
                    const data = await response.json();
                    
                    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Scale Factor: (‡∏Ç‡∏ô‡∏≤‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• / ‡∏Ç‡∏ô‡∏≤‡∏î‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠)
                    const scaleX = canvas.width / video.videoWidth;
                    const scaleY = canvas.height / video.videoHeight;
                    
                    drawBoxes(data.detections, scaleX, scaleY); // ‡∏™‡πà‡∏á scale ‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
                    updateStats(data.detections);
                } catch (err) { console.error(err); }

                if (isStreaming) requestAnimationFrame(detectFrame);
            }, 'image/jpeg');
        }

        async function uploadImage() {
            const input = document.getElementById('uploadInput');
            if (input.files && input.files[0]) {
                internalReset();
                enterActiveMode();
                isImageMode = true;
                staticImage.style.display = 'block';
                const file = input.files[0];
                const imgURL = URL.createObjectURL(file);
                staticImage.src = imgURL;
                staticImage.onload = async () => {
                    canvas.width = staticImage.naturalWidth;
                    canvas.height = staticImage.naturalHeight;
                    updateCanvasSize();
                    processStaticImage();
                }
                input.value = ''; 
            }
        }

        async function processStaticImage() {
             const tempCanvas = document.createElement('canvas');
             tempCanvas.width = staticImage.naturalWidth;
             tempCanvas.height = staticImage.naturalHeight;
             tempCanvas.getContext('2d').drawImage(staticImage, 0, 0);
             tempCanvas.toBlob(async (blob) => {
                 const formData = new FormData();
                 formData.append("file", blob, "upload.jpg");
                 formData.append("conf_thres", currentConf);
                 try {
                    const response = await fetch('/predict', { method: 'POST', body: formData });
                    const data = await response.json();
                    drawBoxes(data.detections, 1, 1); // ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏™‡πÄ‡∏Å‡∏• 1:1
                    updateStats(data.detections);
                 } catch (err) { console.error(err); }
             }, 'image/jpeg');
        }

        // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≠‡∏ö (Priority: Red > Yellow > Green)
        function drawBoxes(detections, scaleX, scaleY) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const colorMap = { 'Red': '#ff3333', 'Green': '#00ff00', 'Yellow': '#ffcc00' };

            // 1. ‡∏´‡∏≤ "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î" (Priority Logic)
            // ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÅ‡∏î‡∏á > ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á > ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
            let mainAlertLabel = "";
            
            const hasRed = detections.some(d => d.label === 'Red');
            const hasYellow = detections.some(d => d.label === 'Yellow');
            const hasGreen = detections.some(d => d.label === 'Green');

            if (hasRed) mainAlertLabel = 'Red';
            else if (hasYellow) mainAlertLabel = 'Yellow';
            else if (hasGreen) mainAlertLabel = 'Green';

            // 2. ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
            if (mainAlertLabel) {
                speakAlert(mainAlertLabel);
            }

            // 3. ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Draw All)
            detections.forEach(det => {
                const x1 = det.bbox[0] * scaleX;
                const y1 = det.bbox[1] * scaleY;
                const x2 = det.bbox[2] * scaleX;
                const y2 = det.bbox[3] * scaleY;
                
                const color = colorMap[det.label] || '#ffffff';
                ctx.strokeStyle = color;
                ctx.lineWidth = 5;
                ctx.beginPath();
                ctx.rect(x1, y1, x2 - x1, y2 - y1);
                ctx.stroke();
                
                ctx.fillStyle = color;
                const text = `${det.label} ${Math.round(det.confidence * 100)}%`;
                const textWidth = ctx.measureText(text).width;
                const labelY = y1 > 40 ? y1 - 40 : y1;
                ctx.fillRect(x1, labelY, textWidth + 20, 40);
                ctx.fillStyle = '#000000';
                ctx.font = "bold 24px Prompt";
                ctx.fillText(text, x1 + 10, labelY + 28);
            });
        }

        function updateStats(detections) {
            let counts = { 'Red': 0, 'Yellow': 0, 'Green': 0 };
            detections.forEach(det => {
                if (counts[det.label] !== undefined) counts[det.label]++;
            });
            document.querySelectorAll('.stat-red-val').forEach(el => el.innerText = counts['Red']);
            document.querySelectorAll('.stat-yellow-val').forEach(el => el.innerText = counts['Yellow']);
            document.querySelectorAll('.stat-green-val').forEach(el => el.innerText = counts['Green']);
        }

        function toggleSound() {
            isSoundEnabled = !isSoundEnabled;
            if (isSoundEnabled) {
                soundBtn.innerHTML = '<i class="fas fa-volume-up"></i> ‡πÄ‡∏™‡∏µ‡∏¢‡∏á: ‡πÄ‡∏õ‡∏¥‡∏î';
                soundBtn.className = 'sound-on';
                const utterance = new SpeechSynthesisUtterance("‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á");
                utterance.lang = 'th-TH'; window.speechSynthesis.speak(utterance);
            } else {
                soundBtn.innerHTML = '<i class="fas fa-volume-mute"></i> ‡πÄ‡∏™‡∏µ‡∏¢‡∏á: ‡∏õ‡∏¥‡∏î';
                soundBtn.className = 'sound-off'; window.speechSynthesis.cancel();
            }
        }
        
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => alert(`Error: ${err.message}`));
            } else {
                document.exitFullscreen();
            }
        }

        function triggerVisualAlert(label) {
            visualOverlay.className = '';
            if (label === 'Red') visualOverlay.classList.add('alert-Red');
            else if (label === 'Green') visualOverlay.classList.add('alert-Green');
            else if (label === 'Yellow') visualOverlay.classList.add('alert-Yellow');
            setTimeout(() => { visualOverlay.className = ''; }, 2000);
        }

        function speakAlert(label) {
            const now = Date.now();
            if (now - lastSpokenTime > 20000 || label !== lastSpokenLabel) {
                if (isSoundEnabled) {
                    let text = "";
                    if (label === 'Red') text = "‡πÑ‡∏ü‡πÅ‡∏î‡∏á ‡∏´‡∏¢‡∏∏‡∏î‡∏£‡∏ñ";
                    else if (label === 'Green') text = "‡πÑ‡∏ü‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß ‡πÑ‡∏õ‡πÑ‡∏î‡πâ";
                    else if (label === 'Yellow') text = "‡πÑ‡∏ü‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á ‡∏£‡∏∞‡∏ß‡∏±‡∏á";
                    if (text) {
                        const utterance = new SpeechSynthesisUtterance(text);
                        utterance.lang = 'th-TH'; window.speechSynthesis.speak(utterance);
                        lastSpokenLabel = label; lastSpokenTime = now;
                    }
                }
                triggerVisualAlert(label);
            }
        }
        
        window.addEventListener('resize', updateCanvasSize);
    </script>
</body>

</html>